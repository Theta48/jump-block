<!doctype html>

<html lang="id">  
<head>  
  <meta charset="utf-8" />  
  <meta name="viewport" content="width=device-width,initial-scale=1" />  
  <title>Pixel Drive - Fixed</title>  
  <style>  
    :root{  
      --bg-night:#0d0d0f;  
      --road:#1a1a1c;  
      --lane:#ffcc00;  
      --dino:#00ff99;  
      --sun:#ffdf5d;  
    }  
    html,body{height:100%;margin:0;font-family: "Press Start 2P", monospace, monospace;background:var(--bg-night);color:#fff;display:flex;align-items:center;justify-content:center;overflow:hidden}  
    canvas{ image-rendering: pixelated; image-rendering: crisp-edges; background: var(--bg-night); border:4px solid #222; display:block; }  
    #ui{ position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 920px; display:flex; justify-content:space-between; align-items:center; gap:8px; z-index:30 }  
    #ui button{ font-family:inherit; background:#222; color:#fff; border:2px solid #444; padding:8px 12px; border-radius:6px; cursor:pointer }  
    #overlay{ position: absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index:40 }  
    #overlay .panel{ pointer-events:auto; background:rgba(0,0,0,0.7); padding:14px 18px; border-radius:8px; border:2px solid #333; text-align:center }  
    #scoreBox{ font-size:12px }  
  </style>  
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">  
</head>  
<body>  
  <canvas id="game"></canvas>    <div id="ui">  
    <div id="scoreBox">SCORE: <span id="score">0</span></div>  
    <div id="scoreBox">HIGH: <span id="highscore">0</span></div>  
    <div>  
      <button id="soundToggle">Sound: On</button>  
      <button id="restartBtn">Restart</button>  
    </div>  
  </div>    <div id="overlay">  
    <div class="panel" id="startPanel">  
      <div style="margin-bottom:8px">Pixel Drive</div>  
      <button id="startButton">Start Game</button>  
      <div id="assetStatus" style="margin-top:8px;font-size:11px;color:#ddd">Loading assets...</div>  
    </div>  
  </div>  <script>  
/* ============================  
   Pixel Drive - Fixed version  
   Waits for assets before enabling start.  
   Provides fallbacks if images fail.  
   ============================ */  
  
const canvas = document.getElementById('game');  
const ctx = canvas.getContext('2d');  
const W = 900, H = 400;  
function fitCanvas(){  
  const r = window.devicePixelRatio || 1;  
  canvas.width = W * r; canvas.height = H * r;  
  canvas.style.width = Math.min(window.innerWidth * 0.95, 900) + 'px';  
  canvas.style.height = (parseFloat(canvas.style.width) * (H / W)) + 'px';  
  ctx.setTransform(r,0,0,r,0,0);  
}  
fitCanvas();  
window.addEventListener('resize', fitCanvas);  
  
// state  
let running = false;  
let score = 0;  
let high = parseInt(localStorage.getItem('pixelDriveHigh')||'0',10) || 0;  
document.getElementById('highscore').innerText = high;  
document.getElementById('score').innerText = score;  
  
const groundY = 320;  
let speed = 8.0;  
let obstacles = [];  
let birds = [];  
const dino = { x:80, y: groundY - 32, w:32, h:32, vy:0, gravity:0.9, jumpPower:-17.5, onGround:true };  
  
let lastTime = 0;  
let spawnTimer = 1200;  
let firstSpawn = true;  
  
// images & load management (promisified)  
const carImg = new Image();  
const birdFrameA = new Image();  
const birdFrameB = new Image();  
  
// Use reliable raw assets; if blocked by CORS or unavailable, code will fallback to drawing shapes.  
carImg.crossOrigin = "anonymous";  
birdFrameA.crossOrigin = "anonymous";  
birdFrameB.crossOrigin = "anonymous";  
  
carImg.src = "https://raw.githubusercontent.com/hampusborgos/pixel-art-vehicles/main/car-red.png";  
birdFrameA.src = "https://raw.githubusercontent.com/hampusborgos/pixel-birds/main/bird1.png";  
birdFrameB.src = "https://raw.githubusercontent.com/hampusborgos/pixel-birds/main/bird2.png";  
  
let carLoaded=false, birdALoaded=false, birdBLoaded=false;  
carImg.onload = ()=>{ carLoaded=true; console.log('car loaded'); updateAssetStatus(); };  
carImg.onerror = ()=>{ carLoaded=false; console.warn('car load failed'); updateAssetStatus(); };  
birdFrameA.onload = ()=>{ birdALoaded=true; console.log('birdA loaded'); updateAssetStatus(); };  
birdFrameA.onerror = ()=>{ birdALoaded=false; console.warn('birdA load failed'); updateAssetStatus(); };  
birdFrameB.onload = ()=>{ birdBLoaded=true; console.log('birdB loaded'); updateAssetStatus(); };  
birdFrameB.onerror = ()=>{ birdBLoaded=false; console.warn('birdB load failed'); updateAssetStatus(); };  
  
function updateAssetStatus(){  
  const s = document.getElementById('assetStatus');  
  s.innerText = `Assets: car ${carLoaded? 'OK':'fallback'}, birdA ${birdALoaded? 'OK':'fallback'}, birdB ${birdBLoaded? 'OK':'fallback'}`;  
  // enable Start only after we've attempted loading (don't wait indefinitely)  
  if(window._assetReadyTimer) clearTimeout(window._assetReadyTimer);  
  // Allow start after 1.2s to avoid blocking if remote server slow  
  window._assetReadyTimer = setTimeout(()=>{ enableStart(); }, 1200);  
}  
  
function enableStart(){  
  const btn = document.getElementById('startButton');  
  btn.disabled = false;  
  btn.style.opacity = 1;  
  document.getElementById('assetStatus').innerText += " â€” Ready";  
  // make sure overlay pointer events allow clicking  
  document.getElementById('overlay').style.pointerEvents = 'auto';  
}  
  
// UI buttons  
document.getElementById('soundToggle').onclick = ()=>{  
  soundOn = !soundOn;  
  document.getElementById('soundToggle').innerText = 'Sound: ' + (soundOn? 'On':'Off');  
};  
document.getElementById('restartBtn').onclick = ()=>{ location.reload(); };  
  
// Input  
document.addEventListener('keydown', e => { if(e.code==='Space'||e.code==='ArrowUp'){ e.preventDefault(); jump(); } });  
document.addEventListener('pointerdown', e => { if(e.target && e.target.id === 'startButton') return; jump(); }, {passive:true});  
  
function jump(){  
  if(!running) return;  
  if(dino.onGround){  
    dino.vy = dino.jumpPower;  
    dino.onGround = false;  
    beep('jump');  
  }  
}  
  
// sound  
let soundOn = true;  
function beep(type='jump'){  
  if(!soundOn) return;  
  try{  
    const a = new (window.AudioContext || window.webkitAudioContext)();  
    const o = a.createOscillator(), g = a.createGain();  
    o.connect(g); g.connect(a.destination);  
    o.frequency.value = (type==='hit'? 160 : 580);  
    g.gain.value = 0.06;  
    o.start();  
    setTimeout(()=>{ o.stop(); a.close(); }, type==='hit'?220:100);  
  }catch(e){ console.warn('audio err', e); }  
}  
  
// spawn logic  
function spawnObstacle(){  
  const r = Math.random();  
  if(r < 0.62){  
    // car ground obstacle  
    const w = 50 + Math.floor(Math.random()*20);  
    const h = 30 + Math.floor(Math.random()*6);  
    obstacles.push({ x: W + (firstSpawn?30:0), y: groundY - h, w, h, type:'car', passed:false });  
  } else if (r < 0.92){  
    const w = 40, h = 32;  
    const heights = [groundY-100, groundY-140, groundY-180];  
    const flyY = heights[Math.floor(Math.random()*heights.length)];  
    birds.push({ x: W + 60, y: flyY, w, h, flap: Math.random()*2, passed:false });  
  } else {  
    // cactus fallback  
    const variants = [{w:20,h:36},{w:28,h:46},{w:38,h:56}];  
    const v = variants[Math.floor(Math.random()*variants.length)];  
    obstacles.push({ x: W + 10, y: groundY - v.h, w: v.w, h: v.h, type:'cactus', passed:false });  
  }  
  firstSpawn = false;  
}  
  
// main loop  
function update(ts){  
  if(!running) return;  
  const dt = Math.min(30, ts - lastTime);  
  lastTime = ts;  
  
  // dino physics  
  if(!dino.onGround) dino.vy += dino.gravity;  
  else dino.vy += dino.gravity * 0.2;  
  dino.y += dino.vy;  
  if(dino.y + dino.h >= groundY){  
    dino.y = groundY - dino.h;  
    dino.vy = 0;  
    dino.onGround = true;  
  }  
  
  spawnTimer -= dt;  
  if(spawnTimer <= 0){  
    spawnObstacle();  
    spawnTimer = 900 + Math.random()*800;  
  }  
  
  // move obstacles  
  for(let i = obstacles.length -1; i >= 0; i--){  
    const o = obstacles[i];  
    o.x -= speed;  
    if(!o.passed && (o.x + o.w) < dino.x){  
      o.passed = true;  
      score += 2;  
      document.getElementById('score').innerText = score;  
      if(score % 50 === 0) speed += 0.5;  
    }  
    if(o.x + o.w < -80) obstacles.splice(i,1);  
    if(collides(dino,o)){ end(); return; }  
  }  
  
  // move birds  
  for(let i = birds.length -1; i >= 0; i--){  
    const b = birds[i];  
    b.x -= (speed + 2);  
    b.flap += dt * 0.01;  
    b.y += Math.sin(b.flap * 6) * 0.5;  
    if(!b.passed && (b.x + b.w) < dino.x){  
      b.passed = true; score += 2; document.getElementById('score').innerText = score;  
    }  
    if(b.x + b.w < -80) birds.splice(i,1);  
    if(collides(dino,b)){ end(); return; }  
  }  
  
  render();  
  requestAnimationFrame(update);  
}  
  
function collides(a,b){  
  return !(a.x + a.w < b.x || a.x > b.x + b.w || a.y + a.h < b.y || a.y > b.y + b.h);  
}  
  
/* rendering */  
const clouds = [];  
for(let i=0;i<6;i++) clouds.push({ x: Math.random()*W, y: Math.random()*180, w: 80 + Math.random()*120, h: 18 + Math.random()*8, speed: 0.06 + Math.random()*0.3, alpha: 0.04 + Math.random()*0.06 });  
  
function render(){  
  // background  
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--bg-night').trim() || '#0d0d0f';  
  ctx.fillRect(0,0,W,H);  
  
  // clouds (pixel blocks)  
  for(const c of clouds){  
    ctx.fillStyle = `rgba(255,255,255,${c.alpha})`;  
    ctx.fillRect(Math.floor(c.x), Math.floor(c.y), Math.floor(c.w), Math.floor(c.h));  
    c.x -= c.speed;  
    if(c.x < -c.w) c.x = W + Math.random()*200;  
  }  
  
  // sun (pixel square)  
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--sun').trim() || '#ffdf5d';  
  ctx.fillRect(W - 64, 44, 12, 12);  
  
  // road  
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--road').trim() || '#1a1a1c';  
  ctx.fillRect(0, groundY, W, H - groundY);  
  
  // dashed lane (pixelated)  
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--lane').trim() || '#ffcc00';  
  ctx.lineWidth = 3;  
  ctx.setLineDash([18,12]);  
  ctx.beginPath();  
  ctx.moveTo(0, groundY + 40);  
  ctx.lineTo(W, groundY + 40);  
  ctx.stroke();  
  ctx.setLineDash([]);  
  
  // dino (player) - pixel block + eye  
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--dino').trim() || '#00ff99';  
  ctx.fillRect(Math.floor(dino.x), Math.floor(dino.y), dino.w, dino.h);  
  ctx.fillStyle = '#004d33';  
  ctx.fillRect(Math.floor(dino.x + dino.w - 10), Math.floor(dino.y + 8), 4, 4);  
  
  // obstacles - cars & cactuses  
  for(const o of obstacles){  
    if(o.type === 'car' && carLoaded){  
      // draw car image with try/catch (in case drawImage throws)  
      try{  
        ctx.drawImage(carImg, Math.floor(o.x), Math.floor(o.y), Math.floor(o.w), Math.floor(o.h));  
      }catch(e){  
        drawCarFallback(o);  
      }  
    } else if (o.type === 'car'){  
      drawCarFallback(o);  
    } else if (o.type === 'cactus'){  
      drawCactus(o);  
    } else {  
      // generic fallback rectangle  
      ctx.fillStyle = '#b22';  
      ctx.fillRect(Math.floor(o.x), Math.floor(o.y), Math.floor(o.w), Math.floor(o.h));  
    }  
  }  
  
  // birds (animated two-frame if available)  
  for(const b of birds){  
    const useImg = (birdALoaded && birdBLoaded);  
    if(useImg){  
      const frame = (Math.floor(b.flap * 10) % 2 === 0) ? birdFrameA : birdFrameB;  
      try{  
        ctx.drawImage(frame, Math.floor(b.x), Math.floor(b.y), Math.floor(b.w), Math.floor(b.h));  
      }catch(e){  
        drawBirdFallback(b);  
      }  
    } else {  
      drawBirdFallback(b);  
    }  
  }  
}  
  
function drawCarFallback(o){  
  ctx.fillStyle = '#ff4d4d';  
  ctx.fillRect(Math.floor(o.x), Math.floor(o.y), Math.floor(o.w), Math.floor(o.h));  
  // wheels  
  ctx.fillStyle = '#222';  
  ctx.fillRect(Math.floor(o.x + 8), Math.floor(o.y + o.h), 12, 8);  
  ctx.fillRect(Math.floor(o.x + o.w - 20), Math.floor(o.y + o.h), 12, 8);  
  // window  
  ctx.fillStyle = 'rgba(255,255,255,0.12)';  
  ctx.fillRect(Math.floor(o.x + 8), Math.floor(o.y + 6), Math.max(6, Math.floor(o.w - 16)), Math.max(6, Math.floor(o.h/3)));  
}  
  
function drawBirdFallback(b){  
  ctx.fillStyle = '#ddd';  
  ctx.beginPath();  
  ctx.moveTo(Math.floor(b.x), Math.floor(b.y + b.h/2));  
  ctx.lineTo(Math.floor(b.x + b.w/2), Math.floor(b.y));  
  ctx.lineTo(Math.floor(b.x + b.w), Math.floor(b.y + b.h/2));  
  ctx.lineTo(Math.floor(b.x + b.w/2), Math.floor(b.y + b.h));  
  ctx.closePath();  
  ctx.fill();  
}  
  
function drawCactus(o){  
  ctx.fillStyle = '#2ecc71';  
  ctx.fillRect(Math.floor(o.x), Math.floor(o.y), Math.floor(o.w), Math.floor(o.h));  
  // arms  
  ctx.fillRect(Math.floor(o.x - 6), Math.floor(o.y + 8), 6, 10);  
  ctx.fillRect(Math.floor(o.x + o.w), Math.floor(o.y + 14), 6, 8);  
}  
  
/* controls: start / end / reset */  
const startBtn = document.getElementById('startButton');  
startBtn.onclick = () => {  
  if(startBtn.disabled) return;  
  document.getElementById('overlay').style.pointerEvents = 'none';  
  document.getElementById('overlay').style.display = 'none';  
  start();  
};  
  
function start(){  
  console.log('Game start');  
  running = true;  
  score = 0;  
  speed = 8.0;  
  obstacles = [];  
  birds = [];  
  dino.y = groundY - dino.h;  
  dino.vy = 0;  
  dino.onGround = true;  
  spawnTimer = 1200;  
  firstSpawn = true;  
  document.getElementById('score').innerText = score;  
  lastTime = performance.now();  
  requestAnimationFrame(update);  
}  
  
function end(){  
  console.log('Game end. Score:', score);  
  running = false;  
  beep('hit');  
  if(score > high){  
    high = score;  
    localStorage.setItem('pixelDriveHigh', high);  
    document.getElementById('highscore').innerText = high;  
  }  
  const ov = document.getElementById('overlay');  
  ov.style.display = 'flex';  
  ov.style.pointerEvents = 'auto';  
  ov.innerHTML = `<div class="panel">  
    <div style="font-size:12px;margin-bottom:8px">ðŸ’¥ GAME OVER ðŸ’¥</div>  
    <div>Score: <strong>${score}</strong></div>  
    <div style="margin-top:8px"><button id="retry">Main Lagi</button></div>  
    <div style="margin-top:8px;font-size:11px;color:#ddd">Assets: car ${carLoaded? 'OK':'fallback'}, birdA ${birdALoaded? 'OK':'fallback'}, birdB ${birdBLoaded? 'OK':'fallback'}</div>  
  </div>`;  
  const retry = document.getElementById('retry');  
  retry.onclick = ()=>{ ov.style.display='none'; ov.style.pointerEvents='none'; start(); };  
}  
  
// safety: allow start even if images take long (enableStart is called after short wait)  
setTimeout(()=>{ enableStart(); }, 1400);  
  
// debug helper: show console notice  
console.log('Pixel Drive loaded. If game does not start, open Console and paste any errors here.');  
  
// try to enable start immediately if assets load quick  
updateAssetStatus();  
  
</script>  </body>  
</html>